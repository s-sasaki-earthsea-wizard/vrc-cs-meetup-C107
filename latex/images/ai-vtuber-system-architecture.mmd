graph TB
    subgraph Discord["Discord収集フェーズ"]
        A[Discord Server<br/>日記用サーバー]
        A1["収集内容の例:<br/>• ポケモンが好き<br/>• 宝塚歌劇が好き<br/>• プラズマ物理を研究<br/>• ル=グウィンが好き<br/>• 実家で犬を飼っている"]
        A -->|自動収集| B[(Knowledge DB<br/>PostgreSQL 17 + pgvector<br/>124レコード蓄積)]
        A --> A1
        B1["DB登録時の処理:<br/>• OpenAI Embeddings APIで<br/>  1536次元ベクトル化<br/>• source/authorで検索可能<br/>• メタデータをJSONBで保存"]
        B --> B1
    end

    subgraph YouTube["YouTube Live配信フェーズ"]
        C1[視聴者の質問:<br/>お芝居は好き？]

        subgraph RAG["RAG検索パイプライン"]
            direction TB
            R1["1. クエリ拡張<br/>LLM: Gemini 2.0 Flash Lite<br/>質問→関連キーワード抽出<br/>例: お芝居→演劇/舞台/俳優"]
            R2["2. ベクトル検索<br/>OpenAI Embeddings<br/>類似度閾値以上の候補取得<br/>候補: 10件程度"]
            R3["3. トピック選択<br/>LLM: Gemini 2.0 Flash Lite<br/>候補から関連度の高い話題選択<br/>選択結果: 1-3件"]
            R4["4. 応答生成<br/>LLM: Gemini 2.5 Flash<br/>選択された記録を<br/>システムプロンプトに注入"]
            R5["5. TTS音声合成<br/>ElevenLabs<br/>VRMアバターが<br/>リップシンクで喋る"]

            R1 --> R2 --> R3 --> R4 --> R5
        end

        C1 --> R1
    end

    B -->|セマンティック検索| R2

    style A fill:#e1f5ff
    style B fill:#fff4e1
    style A1 fill:#e1f5ff,stroke:#999,stroke-dasharray: 5 5
    style B1 fill:#fff4e1,stroke:#999,stroke-dasharray: 5 5
    style C1 fill:#f0e1ff
    style R1 fill:#ffe1f5
    style R2 fill:#ffe1f5
    style R3 fill:#ffe1f5
    style R4 fill:#ffe1f5
    style R5 fill:#ffe1f5
