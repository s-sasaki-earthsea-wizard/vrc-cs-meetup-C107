<style>
@page {
  size: B5;
  margin: 0mm;
}
</style>

## 3. システム全体像 - どう動いているか

### 3.1 キャラクター設定の課題と解決策

AI VTuberを作ろうと思ったとき、最初に当たった壁が「**キャラクターをどう設定するか？**」という問題でした。

一般的なRAGシステムでは、技術ドキュメントやFAQなど、既に存在する静的な知識ベースを使います。しかし、AI VTuberの場合、その「個性」や「記憶」をどう定義するかが課題です。システムプロンプトに長々とキャラクター設定を書き込むのは限界がありますし、何より**不自然**です。

そこで思いついたのが「**Discordに自分の日記用サーバーを立てて、そこのレコードを活用すればいい**」というアイデアでした。

日常的に自分の経験や考えをDiscordに書いておくと、自然にナレッジが溜まっていく。実際、筆者は真実と真実を元にしたフィクションを半分半分くらいで書いています。「宝塚歌劇が好き」「ポケモンのダブルバトルが好き」「プラズマ物理を研究している」といった断片的な情報を、日常会話のように記録していく。

**そして、ここが最も重要なポイントです**: Discordの書き込みをDBに登録する仕組みを作ったので、**Discordに書き込めば勝手にDBの知識が増えていく**のです。

これにより：

- **キャラクター設定の更新が容易**: 新しい趣味や経験を追加したくなったら、Discordに書き込むだけ
- **自然な記憶の蓄積**: 日記を書くような感覚で、AIの「記憶」が成長していく
- **メンテナンスコストの削減**: JSONファイルを手動編集する必要がない

Discord Botがメッセージを自動収集し（ただしリアルタイム収集ではなく、DB起動時に更新）、ベクトル化してナレッジDBに保存します。現在、筆者のナレッジDBには**124件**のレコードが蓄積されています（2025年11月時点）。

### 3.2 システムアーキテクチャ

図3.1は、Discord発言の収集からYouTube Live配信での応答生成までの全体フローを示しています。

![AI VTuberシステムアーキテクチャ](../assets/images/ai-vtuber-system-architecture.svg)

**図3.1: AI VTuberシステムアーキテクチャ - Discord収集からYouTube Live配信まで**

**キーポイント**:

1. **Discordに書き込めば勝手にDBの知識が増えていく** - 日記感覚でキャラクターの記憶を蓄積（現在124レコード）
2. **RAG（検索拡張生成）** - ベクトル検索で意味的に関連する過去発言だけを取得
3. **パーソナライズ応答** - ユーザーの個性を反映した自然な返答を生成
4. **YouTube Live配信** - VRMアバター + TTSで視聴者とリアルタイム対話

### 3.3 技術スタック

#### 本プロジェクトで追加した実装

YouTube Live配信とDiscord連携のために新規実装した機能：

- **Discord連携（新規）**
  - **Discord.js**: Discord API クライアント
  - **機能**: Discordサーバーの投稿を自動収集してDB登録
  - **処理タイミング**: DB起動時に未登録の投稿を一括同期

- **YouTube Live統合（新規）**
  - **YouTube Data API v3**: ライブチャット取得
  - **機能**: 視聴者コメントをリアルタイムでポーリング取得

- **配信統合（新規）**
  - **OBS**: 配信ソフト + Browser Source連携
  - **機能**: VRMアバターとチャット欄をYouTube Live配信に表示

- **knowledge-dbサービス（新規）**
  - **postsテーブル**: Discord投稿の知識ベース
  - **RAG検索API**: ベクトル検索による関連知識の取得エンドポイント
  - **クエリ拡張**: LLMで検索クエリを複数キーワードに展開

#### AIRI本体から継承した技術基盤

フォーク元のAIRIプロジェクトから継承した既存実装：

- **データベース・検索**
  - **PostgreSQL 17**: メインデータベース
  - **pgvector (v0.4.0)**: ベクトル検索拡張
  - **Drizzle ORM**: 型安全なデータベース操作
  - **HNSW インデックス**: 高速近似最近傍探索

- **AI/ML**
  - **LLM**: OpenRouter経由でマルチプロバイダー対応
    - 応答生成: Gemini 2.5 Flash Lite
    - クエリ拡張、トピック選択: Gemini 2.0 Flash Lite
  - **Embeddings**: OpenAI text-embedding-3-small
    - 1536次元ベクトル
    - コスト: $0.00002/1000トークン（激安）

- **VTuber表示**
  - **VRM**: 3Dアバター表示（Three.js）
  - **TTS**: ElevenLabs（音声合成）
  - **stage-web**: ブラウザベースの配信UI

- **既存Bot**
  - **Telegram Bot**: ボイスチャット機能

### 3.4 既存インフラの活用

**重要な設計判断**: 既存のDB構成を活用して新しいテーブルを追加

#### AIRI本体の会話記憶システム

AIRI本体は元々、Telegram Botでの**会話記憶**のために`memory_fragments`テーブルを持っていました。このテーブルには以下の特徴があります：

- **用途**: ボイスチャット時にキャラクターに記憶を持たせる
- **記憶の種類**: working（作業記憶）、short_term（短期記憶）、long_term（長期記憶）、muscle（筋肉記憶）
- **カテゴリ**: chat（会話）、relationships（人間関係）、people（人物）、life（日常生活）等
- **ベクトル検索**: 1536/1024/768次元の3種類に対応

#### 本プロジェクトでの拡張: knowledge-db

本プロジェクトでは、`memory_fragments`とは別に、**Discordの投稿からレコードを登録する**ための新しいテーブル`posts`を追加しました：

- **用途**: AI VTuberのキャラクター設定としての知識ベース
- **データソース**: Discord投稿（筆者の手動入力）
- **検索対象**: YouTube Live配信での応答生成時
- **ベクトル検索**: 同じく1536/1024/768次元の3種類に対応

#### 既存インフラを活用したメリット

新しいテーブルを追加しましたが、**既存のDB構成をそのまま活用**できたため：

1. **PostgreSQL + pgvector**: 既にセットアップ済み
2. **Drizzle ORM**: 型安全なDB操作の仕組みが既にある
3. **HNSWインデックス**: ベクトル検索の高速化手法が既知
4. **複数のベクトル次元対応**: 1536/1024/768次元に対応済み

→ **開発期間短縮、新規インフラ構築不要**

#### 2つのテーブルの役割分担

| テーブル | 用途 | データソース | 検索対象 |
|---------|------|------------|---------|
| `memory_fragments` | 会話記憶 | Telegramチャット履歴 | ボイスチャット時の応答生成 |
| `posts` | 知識ベース | Discord投稿（手動入力） | YouTube Live配信での応答生成 |

この設計により、**会話の記憶**（動的に変化する短期的な情報）と**キャラクター設定としての知識**（固定的な長期的な情報）を分離して管理できるようになりました。

---
