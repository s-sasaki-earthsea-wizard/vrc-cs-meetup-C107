<style>
@page {
  size: B5;
  margin: 0mm;
}
</style>

## 4. RAG検索の工夫と課題解決

すでに2章で述べたように、本システムではナレッジDBの検索の最適化のため、ベクトル検索のみでなく、LLMによるクエリ拡張や文脈に沿ったトピックの選択などを行なっています。

本章ではなぜそのような技術選択をしたのか、という経緯を詳しく解説します。
この方法が一般のRAGとして最適な手法だとは考えていませんし、より洗練された手法もあるはずだと思います。
Discord等のソーシャルメディアの投稿を自身の記憶のように振る舞うAI VTuberの実装例のひとつだと思って読んでいただければ嬉しいです。

### 4.1 ベクトル検索の限界 - 「犬・トキ・ポケモン問題」

#### 単純なベクトル検索の失敗例

開発初期、類似度スコアのみでRAG検索を実装したところ、以下のような問題が発生しました。

**質問**: "好きな動物は？"

**期待される検索結果**:

```text
「わたしの実家には犬がいるんですよ！
ヨークシャーテリアで、今年もう16歳！
...」
```

**実際の検索結果**（類似度順）:

```text
1. [46.2%] 好きな漫画のひとつは「北斗の拳」！〜好きなキャラはトキ！ ← ❌ 無関係だが類似度高い。「トキ」を鳥の朱鷺と勘違いしている？
2. [45.9%] ポケモンのダブルバトルが面白い ← △ 微妙（架空の生き物）
3. [42.2%] 実家には犬がいる。16歳のヨークシャーテリア ← ✅ 本命だが3位
```

「北斗の拳」（トキ等のキャラクター名）や「ポケモン」（架空の生き物）の方が、実際のペットである「犬」よりも類似度が高くなってしまいました。

**原因**:

- 「動物」「好き」という抽象的なクエリでベクトル化
- Embeddingsモデルは文脈を考慮せず、単語の意味的近さのみでスコア化
- 架空の生き物も「動物」カテゴリとして認識される

**この問題を「犬・トキ・ポケモン問題」と名付けました。**

#### なぜ単純な類似度だけでは不十分なのか

ベクトル検索（セマンティック検索）は、従来のキーワード検索と比べて以下の点で優れています：

- ✅ 形態素解析不要 (文字列の分割)
- ✅ 同義語に対応（"ポケモン" = "Pokémon"）
- ✅ 意味的な関連性を捉える
- ✅ 多言語対応

しかし、以下の課題があります：

- ❌ 文脈を考慮しない（架空と現実の区別がつかない）
- ❌ ユーザーの意図を理解できない（ペットの話を聞きたいのか、キャラクターの話を聞きたいのか）
- ❌ 類似度スコアの絶対値に意味がない（46.2%と42.2%の差が重要かは文脈次第）

単純にベクトルの距離だけで判断すると、「トキ（北斗の拳のキャラクター）」と「動物」の意味的な近さが、「犬」と「動物」よりも高く評価されてしまうのです。

### 4.2 解決策: 3段階検索パイプライン

この問題を解決するため、以下の3段階パイプラインを実装しました。

#### 段階1: LLMによるクエリ拡張

**課題**: 「好きな動物は？」だけでは、具体的な動物名が検索に含まれない

**解決**: LLM（Gemini 2.0 Flash Lite）で質問を具体的なキーワードに展開

**プロンプト設計の工夫**:

重要なのは「具体的な固有名詞やカテゴリ名を優先する」よう指示することです：

```markdown
次の質問から、ベクトル検索に有効な具体的なキーワードを抽出してください。

## 重要な指示

### 1. 具体的な固有名詞やカテゴリ名を優先してください
- 良い例: 「犬」「猫」「ゲーム」「アニメ」
- 悪い例: 「好き」「興味」「関心」「楽しみ」

### 2. 抽象的な類義語や汎用的すぎる言葉は避けてください

### 3. 表記ゆれを含めてください
- 例: 「犬」「イヌ」
```

**実行結果**:

```text
質問: "好きな動物は？"
↓
展開されたキーワード: ["動物", "犬", "イヌ", "猫", "ネコ", "鳥", "魚", "ペット"]
```

**効果**: 具体的な動物名で検索することで、「犬」に関する発言がヒットしやすくなります。

**JSONモードの活用**:

確実にキーワードを抽出するため、OpenAI互換のJSON Modeを使用しました：

```json
{
  "type": "json_schema",
  "json_schema": {
    "name": "keyword_extraction",
    "schema": {
      "type": "object",
      "properties": {
        "keywords": { "type": "array", "items": { "type": "string" } }
      },
      "required": ["keywords"]
    }
  }
}
```

これにより、LLMの応答が不安定になることなく、100%確実にJSON形式でキーワードが返ってきます。

#### 段階2: 緩和された閾値でのベクトル検索

**従来の閾値**: 0.7（関連性が高いもののみ）

**新しい閾値**: 0.25（候補を多めに収集）

**理由**:

- クエリ拡張により検索範囲が広がるため、閾値を下げても問題ない
- 次の段階（リランキング）で精度を担保するため、まずは候補を多く集める

**実行結果**:

```text
展開キーワード: ["動物", "犬", "イヌ", "猫", "ネコ", "鳥", "魚", "ペット"]

各キーワードでベクトル検索（閾値0.25）:
- "犬" → 15件ヒット
- "猫" → 8件ヒット
- "ペット" → 12件ヒット
... (合計50件の候補)
```

**重複除外**: IDでユニークな結果のみを保持します。

#### 段階3: LLMによるリランキング

**課題**: 50件の候補から、質問に最も関連するものを選ぶ

**解決**: LLM（Gemini 2.0 Flash Lite）で候補を評価し、Top-Kを選択

**プロンプト例**:

```text
質問: "好きな動物は？"

以下の候補から、この質問に最も関連する発言を選んでください。

候補:
1. 「実家には犬がいて、よく散歩に連れて行っていた」
2. 「北斗の拳が好き！トキとかケンシロウとか...」
3. 「ポケモンのダブルバトルが面白い」
...

重要:
- 実際のペット・動物の話題を優先してください
- 架空の生き物やキャラクターは除外してください
```

**実行結果**:

```text
リランキング後のTop-3:
1. 「実家には犬がいて、よく散歩に連れて行っていた」 ← 正解！
2. 「猫カフェに行ったことがある」
3. 「鳥のさえずりが好き」

除外されたもの:
- 「北斗の拳が好き！トキとかケンシロウとか...」
- 「ポケモンのダブルバトルが面白い」
```

**効果**: 文脈を理解したLLMが、ユーザーの意図に沿った結果を選択しました。

### 4.3 話題の継続（反復的RAG検索）

第2章で紹介した通り、応答内容で再度検索することで話題を深掘りします：

```text
「お芝居は好き？」
  ↓ 第1回検索
「宝塚歌劇が好き」
  ↓ 第2回検索（「宝塚」で再検索）
宝塚歌劇の「はいからさんが通る」の舞台化を観た
  ↓ 第3回検索（「はいからさんが通る」で再検索）
同作のアニメ映画への言及、大正時代への興味
```

ここで前回の応答に関連した話題をDBにクエリをする場合、
当然ながら最初のトピックとして選ばれたレコードが最も関連性が高い話題として選ばれて結局同じ話題が続く、ということがあったので、
これを防ぐために既出のレコードは候補から除外し、話題を広げていくようにしています。

これにより、単発の質問応答ではなく、会話が自然に深まっていく体験を実現できました。

---
